<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Masjid As-Sunnah Hekinan — Jadwal Sholat & Donasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    html{scroll-behavior:smooth}
    [data-lucide]{transition:transform .2s ease}
    .card{transition:transform .15s ease,box-shadow .15s ease}
    .card:hover{transform:translateY(-2px)}
    #progressBar{transition:width 1s ease;background:linear-gradient(90deg,#0ea5e9,#38bdf8)}
    .scrollx-snap{scroll-snap-type:x mandatory}
    .snap-item{scroll-snap-align:start}
    .hide-scrollbar{scrollbar-width:none;-ms-overflow-style:none}
    .hide-scrollbar::-webkit-scrollbar{display:none}
    .tab-slider{position:absolute;bottom:0;height:2px;width:50%;background:#0ea5e9;transition:transform .25s ease}
    .tab-left .tab-slider{transform:translateX(0)}
    .tab-right .tab-slider{transform:translateX(100%)}
  </style>
</head>

<body class="font-sans text-slate-800 bg-gradient-to-b from-sky-50 to-white">
  <!-- Header -->
  <header class="sticky top-0 bg-white/80 backdrop-blur border-b border-slate-200 z-40">
    <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex gap-3 items-center">
        <img src="logohekinan.jpeg" class="h-10 w-auto rounded-md" alt="logo">
        <h1 class="font-extrabold text-lg md:text-xl text-slate-900">Masjid As-Sunnah Hekinan</h1>
      </div>
      <div class="flex items-center gap-3 text-sm">
        <a href="#sholat" class="hover:text-sky-700 flex items-center gap-1"><i data-lucide="moon-star" class="w-4 h-4"></i>Sholat</a>
        <a href="#info" class="hover:text-sky-700 flex items-center gap-1"><i data-lucide="layers" class="w-4 h-4"></i>Info</a>
        <a href="#donasi" class="rounded-xl bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 font-semibold">Donasi</a>
        <!-- tombol admin hanya untuk admin -->
        <button id="openData" class="admin-only hidden rounded-xl border border-slate-300 px-3 py-2 hover:border-sky-600 flex items-center gap-2">
          <i data-lucide="settings-2" class="w-4 h-4"></i>⚙️ Data
        </button>
      </div>
    </nav>
  </header>

  <!-- JADWAL SHOLAT -->
  <section id="sholat" class="container mx-auto px-4 py-10">
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow card">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-extrabold flex items-center gap-2"><i data-lucide="moon-star" class="text-sky-600"></i>Jadwal Sholat</h2>
          <p id="locLabel" class="text-sm text-slate-600 mt-1">Mendeteksi lokasi…</p>
        </div>
        <button id="refreshSholat" class="rounded-xl border border-slate-300 hover:border-sky-600 px-3 py-2 text-sm flex items-center gap-2">
          <i data-lucide="refresh-cw" class="w-4 h-4"></i>Perbarui
        </button>
      </div>
      <div id="sholatGrid" class="mt-6 grid grid-cols-2 md:grid-cols-6 gap-3"></div>
      <p class="mt-3 text-xs text-slate-500">Waktu mengikuti zona perangkat Anda.</p>
    </div>
  </section>

  <!-- INFO (TAB: PENGUMUMAN & ARTIKEL) -->
  <section id="info" class="container mx-auto px-4 py-10">
    <div id="tabs" class="relative tab-left">
      <div class="flex gap-2">
        <button id="tabPengumuman" class="flex-1 rounded-xl px-4 py-2 text-sm font-semibold border border-slate-300 bg-slate-50">Pengumuman</button>
        <button id="tabArtikel" class="flex-1 rounded-xl px-4 py-2 text-sm font-semibold border border-slate-300 bg-slate-50">Artikel</button>
      </div>
      <span class="tab-slider"></span>
    </div>

    <!-- Pengumuman -->
    <div id="wrapPengumuman" class="mt-6 grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <p id="boardEmpty" class="hidden text-sm text-slate-500">Belum ada pengumuman.</p>

    <!-- Artikel -->
    <div id="wrapArtikel" class="mt-6 hidden">
      <div class="flex justify-end">
        <div class="relative">
          <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
          <input id="searchArtikel" type="search" placeholder="Cari artikel…" class="pl-9 pr-3 py-2 rounded-xl border border-slate-300 focus:border-sky-600 text-sm w-64 max-w-full">
        </div>
      </div>
      <div id="artikelList" class="mt-4 grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <p id="artikelEmpty" class="hidden text-sm text-slate-500">Belum ada artikel.</p>
    </div>
  </section>

  <!-- DONASI -->
  <section id="donasi" class="container mx-auto px-4 pb-12">
    <h2 class="text-2xl font-extrabold mb-4 flex items-center gap-2"><i data-lucide="heart-handshake" class="text-rose-600"></i>Progres Donasi</h2>
    <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6 card">
      <div class="flex justify-between items-end">
        <div><p class="text-sm text-slate-600">Terkumpul</p><p id="terkumpulLabel" class="text-3xl font-bold">JPY 0</p></div>
        <div class="text-right"><p class="text-sm text-slate-600">Target</p><p id="targetLabel" class="text-2xl font-bold">JPY 0</p></div>
      </div>
      <div class="mt-4 w-full bg-white rounded-full border border-slate-200 overflow-hidden"><div id="progressBar" class="h-3 w-0"></div></div>
      <p class="mt-2 text-sm text-slate-600"><span id="percentLabel">0</span>% tercapai</p>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="bg-white">
    <div class="container mx-auto px-4 py-10 text-sm text-slate-700 flex justify-between">
      <span>© <small id="year"></small> Masjid As-Sunnah Hekinan.</span>
      <span>Designed with ♥️ Abu Khayla.</span>
    </div>
  </footer>

  <!-- MODAL ADMIN (HIDDEN) -->
  <div id="dataModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
    <div class="w-full max-w-2xl rounded-2xl bg-white p-6 shadow">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold flex items-center gap-2"><i data-lucide="database"></i>Sumber Data</h3>
        <button id="closeData">✕</button>
      </div>
      <p class="text-sm text-slate-600">Tempel URL Google Sheet yang sudah <b>Publish to the web → CSV</b>.</p>
      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="text-sm font-semibold">CSV Pengumuman</label>
          <input id="csvPengumuman" type="url" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
        </div>
        <div>
          <label class="text-sm font-semibold">CSV Artikel</label>
          <input id="csvArtikel" type="url" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
        </div>
      </div>
      <div class="text-right mt-4">
        <button id="saveData" class="rounded-xl bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 text-sm">Simpan</button>
      </div>
    </div>
  </div>

  <!-- APP SCRIPT -->
  <script type="module">
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>[...r.querySelectorAll(s)];
    $('#year').textContent=new Date().getFullYear(); lucide.createIcons();

    /* ===== Admin gate ===== */
    const ADMIN_CODE='as-sunnah-2025';
    const isAdmin=()=>localStorage.getItem('is_admin')==='1'||location.search.includes('admin=1');
    if(isAdmin()) $$('.admin-only').forEach(el=>el.classList.remove('hidden'));
    document.addEventListener('keydown',e=>{
      if(e.ctrlKey&&e.altKey&&e.key.toLowerCase()==='a'){
        const c=prompt('Masukkan kode admin:');
        if(c===ADMIN_CODE){localStorage.setItem('is_admin','1');alert('Admin mode aktif.');$$('.admin-only').forEach(el=>el.classList.remove('hidden'));}
      }
    });
    $('#openData')?.addEventListener('click',()=>{
      $('#csvPengumuman').value=localStorage.getItem('sheet_pengumuman')||'';
      $('#csvArtikel').value=localStorage.getItem('sheet_artikel')||'';
      $('#dataModal').classList.remove('hidden'); $('#dataModal').classList.add('flex');
    });
    $('#closeData')?.addEventListener('click',()=>$('#dataModal').classList.add('hidden'));
    $('#saveData')?.addEventListener('click',()=>{
      localStorage.setItem('sheet_pengumuman',$('#csvPengumuman').value.trim());
      localStorage.setItem('sheet_artikel',$('#csvArtikel').value.trim());
      alert('URL tersimpan. Refresh halaman.'); $('#dataModal').classList.add('hidden'); loadInfo();
    });

    /* ===== Jadwal Sholat ===== */
    const FALLBACK={lat:34.884,lon:136.993,label:'Hekinan'};
    async function getTimes(lat,lon){const j=await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`).then(r=>r.json());return j.data?.timings;}
    function makeCard(label,time,ic){const e=document.createElement('div');e.className="rounded-xl border border-slate-200 p-4 text-center bg-white";e.innerHTML=`<i data-lucide="${ic}" class="w-5 h-5 mx-auto text-sky-600 mb-2"></i><div class="text-xs text-slate-500">${label}</div><div class="mt-1 text-xl font-bold">${time||'—'}</div>`;return e;}
    async function renderSholat(){
      const g=$("#sholatGrid"); g.innerHTML='<p>Memuat…</p>';
      let pos=null; try{ pos=await new Promise(r=>navigator.geolocation.getCurrentPosition(p=>r({lat:p.coords.latitude,lon:p.coords.longitude}),()=>r(null),{enableHighAccuracy:true,timeout:7000})) }catch{}
      pos=pos||FALLBACK; $("#locLabel").textContent=`Lokasi: (${pos.lat.toFixed(3)}, ${pos.lon.toFixed(3)})`;
      try{
        const t=await getTimes(pos.lat,pos.lon); g.innerHTML='';
        const map={Fajr:['Subuh','sunrise'],Sunrise:['Syuruq','sun'],Dhuhr:['Dzuhur','clock'],Asr:['Ashar','cloud-sun'],Maghrib:['Maghrib','moon'],Isha:['Isya','star']};
        Object.keys(map).forEach(k=> g.appendChild(makeCard(map[k][0], t?.[k], map[k][1])) );
        lucide.createIcons();
      }catch{ g.innerHTML='<p class="text-red-600">Gagal memuat jadwal.</p>'; }
    }
    $('#refreshSholat').addEventListener('click',renderSholat); renderSholat();

    /* ===== CSV parser aman (kutip & koma) ===== */
    function parseCSV(text){
      const rows=[], n=text.length; let i=0, cur='', row=[], inQ=false;
      while(i<n){
        const c=text[i];
        if(c=='"'){ if(inQ && text[i+1]=='"'){cur+='"'; i+=2; continue;} inQ=!inQ; i++; continue; }
        if(!inQ && c==','){ row.push(cur); cur=''; i++; continue; }
        if(!inQ && (c=='\n'||c=='\r')){ if(cur!==''||row.length){ row.push(cur); rows.push(row); row=[]; cur=''; } if(c=='\r'&&text[i+1]=='\n') i++; i++; continue; }
        cur+=c; i++;
      }
      if(cur!==''||row.length){ row.push(cur); rows.push(row); }
      if(!rows.length) return [];
      const head=rows[0].map(h=>h.trim().toLowerCase());
      return rows.slice(1).map(cols=>{ const o={}; head.forEach((h,idx)=> o[h]=(cols[idx]||'').trim()); return o; });
    }
    const normalizeUrl=u=>{ if(!u) return ''; u=u.trim(); if(!/^https?:\/\//i.test(u)) u='https://'+u; return u; };

    /* ===== Data loader (CSV / JSON / sample) ===== */
    async function loadCsv(u){ if(!u) return null; try{ const t=await fetch(u,{cache:'no-store'}).then(r=>r.text()); return parseCSV(t); }catch{ return null; } }
    async function loadJson(u){ try{ return await fetch(u,{cache:'no-store'}).then(r=>r.json()); }catch{ return null; } }
    async function getPeng(){ return (await loadCsv(localStorage.getItem('sheet_pengumuman'))) || await loadJson('pengumuman.json') || []; }
    async function getArt(){ return (await loadCsv(localStorage.getItem('sheet_artikel')))    || await loadJson('artikel.json')    || []; }

    function cardPeng({title,date,desc,link}){
      const e=document.createElement('article'); e.className="rounded-2xl border border-slate-200 bg-white p-5 shadow card";
      const dt=date?new Date(date):null, txt=dt&&!isNaN(dt)?dt.toLocaleDateString('id-ID',{weekday:'short',year:'numeric',month:'short',day:'numeric'}):'';
      e.innerHTML=`<div class="text-xs text-slate-500">${txt}</div>
        <h3 class="mt-1 font-bold text-slate-900">${title||''}</h3>
        <p class="mt-2 text-sm text-slate-700">${desc||''}</p>
        ${link?`<a href="${normalizeUrl(link)}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 mt-3 text-sky-700 hover:underline text-sm"><i data-lucide="arrow-right"></i> Detail</a>`:''}`;
      return e;
    }
    function cardArt({title,excerpt,link,tag}){
      const e=document.createElement('article'); e.className="rounded-2xl border border-slate-200 bg-white p-5 shadow card";
      const badges=(tag||'').split('|').filter(Boolean).map(t=>`<span class="text-xs px-2 py-1 rounded-full bg-slate-100">${t}</span>`).join('');
      e.innerHTML=`<h3 class="font-bold text-slate-900">${title||''}</h3>
        <p class="mt-2 text-sm text-slate-700">${excerpt||''}</p>
        <div class="mt-3 flex flex-wrap gap-2">${badges}</div>
        ${link?`<a href="${normalizeUrl(link)}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 mt-4 text-emerald-700 hover:underline text-sm"><i data-lucide="book-open"></i> Baca</a>`:''}`;
      return e;
    }

    async function loadInfo(){
      // Pengumuman
      const P=await getPeng(); const wrapP=$("#wrapPengumuman"), emptyP=$("#boardEmpty");
      wrapP.innerHTML=''; if(!P.length){ emptyP.classList.remove('hidden'); } else { emptyP.classList.add('hidden'); P.forEach(x=>wrapP.appendChild(cardPeng(x))); }

      // Artikel
      const A=await getArt(); const list=$("#artikelList"), emptyA=$("#artikelEmpty");
      function renderA(q=''){
        const s=q.trim().toLowerCase(); list.innerHTML='';
        const data=A.filter(a=>{
          const tags=(a.tag||'').toLowerCase();
          return !s || (a.title||'').toLowerCase().includes(s) || (a.excerpt||'').toLowerCase().includes(s) || tags.includes(s);
        });
        if(!data.length){ emptyA.classList.remove('hidden'); } else { emptyA.classList.add('hidden'); data.forEach(a=> list.appendChild(cardArt(a))); }
        lucide.createIcons();
      }
      renderA();
      $('#searchArtikel')?.addEventListener('input', e=>renderA(e.target.value));
      lucide.createIcons();
    }
    loadInfo();

    // Tabs
    $('#tabPengumuman').addEventListener('click',()=>{$('#wrapPengumuman').classList.remove('hidden');$('#wrapArtikel').classList.add('hidden');$('#tabs').classList.add('tab-left');$('#tabs').classList.remove('tab-right');});
    $('#tabArtikel').addEventListener('click',()=>{$('#wrapPengumuman').classList.add('hidden');$('#wrapArtikel').classList.remove('hidden');$('#tabs').classList.remove('tab-left');$('#tabs').classList.add('tab-right');});

    /* ===== Donasi progress ===== */
    const TARGET=42000000, TERKUMPUL=5290797;
    function renderProgress(){
      $('#terkumpulLabel').textContent=new Intl.NumberFormat('id-ID',{style:'currency',currency:'JPY',maximumFractionDigits:0}).format(TERKUMPUL);
      $('#targetLabel').textContent=new Intl.NumberFormat('id-ID',{style:'currency',currency:'JPY',maximumFractionDigits:0}).format(TARGET);
      const p=Math.min(100,Math.round((TERKUMPUL/TARGET)*100));
      $('#percentLabel').textContent=p;
      const bar=$('#progressBar'); bar.style.width='0%'; requestAnimationFrame(()=>setTimeout(()=>bar.style.width=p+'%',40));
    }
    renderProgress();
  </script>
</body>
</html>
