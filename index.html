<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Masjid As-Sunnah Hekinan — Donasi, Jadwal Sholat, Pengumuman & Artikel</title>

  <!-- Tailwind & Lucide -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    html{scroll-behavior:smooth}
    :focus-visible{outline:3px solid #38bdf8; outline-offset:2px; border-radius:.6rem}
    [data-lucide]{transition:transform .25s ease}
    .card{transition:transform .15s ease, box-shadow .15s ease}
    .card:hover{transform:translateY(-1px)}
    #progressBar{transition:width 1s cubic-bezier(.22,.61,.36,1); background:linear-gradient(90deg,#0ea5e9,#38bdf8)}
    .scrollx-snap{scroll-snap-type:x mandatory}
    .snap-item{scroll-snap-align:start}
    .hide-scrollbar{scrollbar-width:none;-ms-overflow-style:none}
    .hide-scrollbar::-webkit-scrollbar{display:none}
    .tab-slider{position:absolute;bottom:0;height:2px;width:50%;background:#0ea5e9;transition:transform .25s ease}
    .tab-left .tab-slider{transform:translateX(0)}
    .tab-right .tab-slider{transform:translateX(100%)}
    /* Modal blur */
    .modal{backdrop-filter:blur(4px)}
  </style>
</head>

<body class="font-sans text-slate-800 bg-gradient-to-b from-sky-50 to-white">
  <!-- ================= HEADER ================= -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/80 border-b border-slate-200/70">
    <nav class="container mx-auto px-4 py-3 flex items-center justify-between">
      <a href="#top" class="flex items-center gap-3">
        <img src="logohekinan.jpeg" alt="Logo Masjid As-Sunnah Hekinan" class="h-10 w-auto rounded-md" loading="lazy">
        <span class="font-extrabold text-slate-900 text-lg">Masjid As-Sunnah Hekinan</span>
      </a>

      <div class="hidden md:flex items-center gap-5 text-sm">
        <a href="#sholat" class="hover:text-sky-700 flex items-center gap-2"><i data-lucide="moon-star" class="w-4 h-4"></i>Jadwal Sholat</a>
        <a href="#kegiatan" class="hover:text-sky-700 flex items-center gap-2"><i data-lucide="images" class="w-4 h-4"></i>Kegiatan</a>
        <a href="#info" class="hover:text-sky-700 flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4"></i>Pengumuman/Artikel</a>
        <a href="#donasi" class="rounded-xl bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 font-semibold shadow">Donasi</a>
        <!-- Tombol admin disembunyikan default -->
        <button id="openData" class="admin-only hidden rounded-xl border border-slate-300 px-3 py-2 hover:border-sky-600 flex items-center gap-2">
          <i data-lucide="settings-2" class="w-4 h-4"></i> ⚙️ Data
        </button>
      </div>

      <!-- Burger -->
      <button id="burgerBtn" class="md:hidden rounded-lg border border-slate-300 p-2" aria-label="Menu" aria-expanded="false">
        <i data-lucide="menu"></i>
      </button>
    </nav>

    <!-- Mobile menu -->
    <div id="mobileMenu" class="hidden md:hidden px-4 pb-4 border-t border-slate-200 bg-white/95">
      <div class="flex flex-col gap-2 text-sm">
        <a href="#sholat" class="hover:text-sky-700 py-1">Jadwal Sholat</a>
        <a href="#kegiatan" class="hover:text-sky-700 py-1">Kegiatan</a>
        <a href="#info" class="hover:text-sky-700 py-1">Pengumuman/Artikel</a>
        <a href="#donasi" class="rounded-xl bg-sky-600 hover:bg-sky-700 text-white text-center px-4 py-2">Donasi</a>
      </div>
    </div>
  </header>

  <!-- ================= JADWAL SHOLAT ================= -->
  <section id="sholat" class="container mx-auto px-4 py-10">
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow card">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 flex items-center gap-2">
            <i data-lucide="moon-star" class="text-sky-600"></i> Jadwal Sholat
          </h2>
          <p id="locLabel" class="text-sm text-slate-600 mt-1">Mendeteksi lokasi…</p>
        </div>
        <button id="refreshSholat" class="rounded-xl border border-slate-300 hover:border-sky-600 px-3 py-2 text-sm flex items-center gap-2">
          <i data-lucide="refresh-cw" class="w-4 h-4"></i>Perbarui
        </button>
      </div>

      <div id="sholatGrid" class="mt-6 grid grid-cols-2 md:grid-cols-6 gap-3">
        <!-- akan diisi JS -->
      </div>
      <p class="mt-3 text-xs text-slate-500">Waktu mengikuti zona waktu perangkat Anda.</p>
    </div>
  </section>

  <!-- ================= KEGIATAN (SLIDESHOW) ================= -->
  <section id="kegiatan" class="bg-white border-y border-slate-200/70">
    <div class="container mx-auto px-4 py-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 flex items-center gap-2">
          <i data-lucide="images" class="text-fuchsia-600"></i> Kegiatan
        </h2>
        <div class="hidden md:flex items-center gap-2">
          <button id="kgPrev" class="rounded-xl border border-slate-300 px-3 py-2 hover:border-sky-600">◀</button>
          <button id="kgNext" class="rounded-xl border border-slate-300 px-3 py-2 hover:border-sky-600">▶</button>
        </div>
      </div>

      <div class="relative">
        <div id="kgTrack" class="scrollx-snap hide-scrollbar flex gap-4 overflow-x-auto rounded-2xl border border-slate-200 p-4">
          <!-- ganti gambar sesuai folder kamu -->
          <figure class="snap-item shrink-0 w-[85%] sm:w-[60%] md:w-[45%] lg:w-[32%] h-64 md:h-80 rounded-xl overflow-hidden bg-slate-100">
            <img src="./1.jpeg" class="w-full h-full object-cover" alt="Kegiatan 1" loading="lazy">
          </figure>
          <figure class="snap-item shrink-0 w-[85%] sm:w-[60%] md:w-[45%] lg:w-[32%] h-64 md:h-80 rounded-xl overflow-hidden bg-slate-100">
            <img src="./2.jpeg" class="w-full h-full object-cover" alt="Kegiatan 2" loading="lazy">
          </figure>
          <figure class="snap-item shrink-0 w-[85%] sm:w-[60%] md:w-[45%] lg:w-[32%] h-64 md:h-80 rounded-xl overflow-hidden bg-slate-100">
            <img src="./3.jpeg" class="w-full h-full object-cover" alt="Kegiatan 3" loading="lazy">
          </figure>
          <figure class="snap-item shrink-0 w-[85%] sm:w-[60%] md:w-[45%] lg:w-[32%] h-64 md:h-80 rounded-xl overflow-hidden bg-slate-100">
            <img src="./4.jpeg" class="w-full h-full object-cover" alt="Kegiatan 4" loading="lazy">
          </figure>
        </div>
        <!-- Mobile controls -->
        <div class="md:hidden absolute inset-y-0 left-0 flex items-center">
          <button id="kgPrevMob" class="m-2 rounded-full bg-white/80 hover:bg-white p-2 shadow">◀</button>
        </div>
        <div class="md:hidden absolute inset-y-0 right-0 flex items-center">
          <button id="kgNextMob" class="m-2 rounded-full bg-white/80 hover:bg-white p-2 shadow">▶</button>
        </div>
      </div>

      <p class="mt-4 text-center text-xs text-slate-500">Geser kiri/kanan atau pakai tombol ◀ ▶.</p>
    </div>
  </section>

  <!-- ================= PENGUMUMAN + ARTIKEL (TABS, HEMAT RUANG) ================= -->
  <section id="info" class="container mx-auto px-4 py-10">
    <div id="tabs" class="relative tab-left">
      <div class="flex gap-2">
        <button id="tabPengumuman" class="flex-1 rounded-xl px-4 py-2 text-sm font-semibold border border-slate-300 bg-slate-50 hover:bg-slate-100 focus:bg-sky-50">Pengumuman</button>
        <button id="tabArtikel"    class="flex-1 rounded-xl px-4 py-2 text-sm font-semibold border border-slate-300 bg-slate-50 hover:bg-slate-100 focus:bg-sky-50">Artikel</button>
      </div>
      <span class="tab-slider"></span>
    </div>

    <!-- Pengumuman -->
    <div id="wrapPengumuman" class="mt-6 grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <p id="boardEmpty" class="hidden text-sm text-slate-500">Belum ada pengumuman.</p>

    <!-- Artikel -->
    <div id="wrapArtikel" class="mt-6 hidden">
      <div class="flex justify-end">
        <div class="relative">
          <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
          <input id="searchArtikel" placeholder="Cari artikel…" class="pl-9 pr-3 py-2 rounded-xl border border-slate-300 focus:border-sky-600 text-sm w-64 max-w-full">
        </div>
      </div>
      <div id="artikelList" class="mt-4 grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      <p id="artikelEmpty" class="hidden text-sm text-slate-500">Belum ada artikel.</p>
    </div>
  </section>

  <!-- ================= DONASI ================= -->
  <section id="donasi" class="container mx-auto px-4 pb-12">
    <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900 mb-4 flex items-center gap-2">
      <i data-lucide="heart-handshake" class="text-rose-600"></i> Progres Donasi Masjid
    </h2>

    <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6 card">
      <div class="flex items-end justify-between gap-4">
        <div>
          <p class="text-sm text-slate-600">Terkumpul</p>
          <p id="terkumpulLabel" class="text-2xl md:text-3xl font-extrabold text-slate-900">JPY 0</p>
        </div>
        <div class="text-right">
          <p class="text-sm text-slate-600">Target</p>
          <p id="targetLabel" class="text-xl md:text-2xl font-extrabold text-slate-900">JPY 0</p>
        </div>
      </div>

      <div class="mt-4 w-full bg-white rounded-full border border-slate-200 overflow-hidden">
        <div id="progressBar" class="h-3 w-0"></div>
      </div>
      <div class="mt-2 text-sm text-slate-600"><span id="percentLabel">0</span>% tercapai</div>

      <!-- Nominal & WA -->
      <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-5">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm font-semibold">Nominal (JPY)</label>
            <input id="inputJPY" type="number" min="1000" step="1000" placeholder="Masukkan JPY"
                   class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:border-sky-600"/>
            <div class="mt-2 flex flex-wrap gap-2 text-xs">
              <button class="quick-btn-jpy rounded-xl border border-slate-300 px-3 py-1" data-v="1000">1.000</button>
              <button class="quick-btn-jpy rounded-xl border border-slate-300 px-3 py-1" data-v="5000">5.000</button>
              <button class="quick-btn-jpy rounded-xl border border-slate-300 px-3 py-1" data-v="10000">10.000</button>
              <button class="quick-btn-jpy rounded-xl border border-slate-300 px-3 py-1" data-v="20000">20.000</button>
            </div>
          </div>
          <div>
            <label class="text-sm font-semibold">Nominal (IDR)</label>
            <input id="inputIDR" type="number" min="10000" step="1000" placeholder="Masukkan IDR"
                   class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2 focus:border-sky-600"/>
            <div class="mt-2 flex flex-wrap gap-2 text-xs">
              <button class="quick-btn-idr rounded-xl border border-slate-300 px-3 py-1" data-v="50000">50.000</button>
              <button class="quick-btn-idr rounded-xl border border-slate-300 px-3 py-1" data-v="100000">100.000</button>
              <button class="quick-btn-idr rounded-xl border border-slate-300 px-3 py-1" data-v="200000">200.000</button>
              <button class="quick-btn-idr rounded-xl border border-slate-300 px-3 py-1" data-v="500000">500.000</button>
            </div>
          </div>
        </div>

        <button id="donasiBtn" class="mt-4 w-full rounded-2xl bg-sky-600 hover:bg-sky-700 text-white font-semibold px-6 py-3">
          Konfirmasi via WhatsApp
        </button>
        <p class="mt-2 text-[11px] text-slate-500">Minimal: 1.000 JPY atau 10.000 IDR.</p>
      </div>

      <!-- Rekening -->
      <div class="mt-6 grid md:grid-cols-2 gap-6">
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
          <h3 class="text-lg font-bold text-slate-900">🇯🇵 Jepang — Yucho Bank</h3>
          <ul class="mt-2 text-sm text-slate-700 space-y-1">
            <li>a.n. <span class="font-medium">Yoshimine Adelfa</span></li>
            <li>No. Rekening: <span class="font-medium" id="rekYucho">12160-00457031</span></li>
          </ul>
          <button data-copy="#rekYucho" class="mt-3 rounded-lg border border-slate-300 px-3 py-1 text-xs hover:border-sky-600">Salin No. Rek</button>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-white p-5">
          <h3 class="text-lg font-bold text-slate-900">🇮🇩 Indonesia — Bank Syariah Indonesia</h3>
          <ul class="mt-2 text-sm text-slate-700 space-y-1">
            <li>a.n. <span class="font-medium">DKM Masjid As-Sunnah Hekinan</span></li>
            <li>No. Rekening: <span class="font-medium" id="rekBsi">Segera diumumkan</span></li>
          </ul>
          <button data-copy="#rekBsi" class="mt-3 rounded-lg border border-slate-300 px-3 py-1 text-xs hover:border-sky-600">Salin No. Rek</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ================= FOOTER ================= -->
  <footer class="bg-white">
    <div class="container mx-auto px-4 py-10">
      <div class="grid md:grid-cols-3 gap-8">
        <div>
          <img src="logohekinan.jpeg" alt="Logo Masjid As-Sunnah Hekinan" class="h-12 w-auto mb-3" loading="lazy">
          <h3 class="font-bold text-slate-900">Masjid As-Sunnah Hekinan</h3>
          <p class="mt-2 text-sm text-slate-700">1 Chome-8 Dojoyamamachi, Hekinan, Aichi 447-0864</p>
          <p class="mt-1 text-sm text-slate-700">Email: hekinanmosque@gmail.com</p>
        </div>
        <div>
          <h3 class="font-bold text-slate-900">Tautan</h3>
          <ul class="mt-2 space-y-2 text-sm">
            <li><a href="#sholat" class="hover:text-sky-700">Jadwal Sholat</a></li>
            <li><a href="#kegiatan" class="hover:text-sky-700">Kegiatan</a></li>
            <li><a href="#info" class="hover:text-sky-700">Pengumuman & Artikel</a></li>
            <li><a href="#donasi" class="hover:text-sky-700">Donasi</a></li>
          </ul>
        </div>
        <div>
          <h3 class="font-bold text-slate-900">Ikuti Kami</h3>
          <ul class="mt-2 space-y-2 text-sm">
            <li><a href="https://www.instagram.com/assunnahhekinan" target="_blank" rel="noopener" class="hover:text-sky-700">Instagram</a></li>
            <li><a href="https://www.youtube.com/@assunnahhekinan" target="_blank" rel="noopener" class="hover:text-sky-700">YouTube</a></li>
          </ul>
        </div>
      </div>
      <div class="mt-8 border-t border-slate-200 pt-6 text-xs text-slate-500 flex flex-col md:flex-row justify-between">
        <p>© <span id="year"></span> Masjid As-Sunnah Hekinan. Semua hak cipta dilindungi.</p>
        <p>Designed with ♥️ Abu Khayla.</p>
      </div>
    </div>
  </footer>

  <!-- ================= MODAL ADMIN (TERSEMBUNYI) ================= -->
  <div id="dataModal" class="modal fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50">
    <div class="w-full max-w-2xl rounded-2xl bg-white p-6 shadow">
      <div class="flex items-start justify-between gap-4">
        <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2"><i data-lucide="database"></i> Sumber Data</h3>
        <button id="closeData" class="text-slate-500 hover:text-slate-700" aria-label="Tutup">✕</button>
      </div>
      <p class="mt-2 text-sm text-slate-600">
        Tempel URL <b>Google Sheet → Publish to the web → CSV</b>. Tersimpan di browser (hanya admin).
      </p>
      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="rounded-xl border border-slate-200 p-4">
          <label class="text-sm font-semibold">CSV Pengumuman</label>
          <input id="csvPengumuman" type="url" placeholder="https://docs.google.com/.../pub?output=csv" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2 focus:border-sky-600">
          <p class="text-xs text-slate-500 mt-2">Kolom: <code>title,date,desc,link</code></p>
        </div>
        <div class="rounded-xl border border-slate-200 p-4">
          <label class="text-sm font-semibold">CSV Artikel</label>
          <input id="csvArtikel" type="url" placeholder="https://docs.google.com/.../pub?output=csv" class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2 focus:border-sky-600">
          <p class="text-xs text-slate-500 mt-2">Kolom: <code>title,tag,excerpt,link</code> (tag pakai <code>|</code>)</p>
        </div>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="saveData" class="rounded-xl bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 text-sm font-semibold">Simpan</button>
      </div>
      <hr class="my-4">
      <p class="text-xs text-slate-500">
        Fallback opsional: sediakan <code>pengumuman.json</code> & <code>artikel.json</code> (array objek) di folder yang sama.
      </p>
    </div>
  </div>

  <!-- ================= APP SCRIPT ================= -->
  <script type="module">
    /* ====== Helper ====== */
    const $  = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
    const fmtJPY = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:'JPY',maximumFractionDigits:0}).format(n||0);
    const fmtIDR = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(n||0);
    $('#year').textContent = new Date().getFullYear();
    lucide.createIcons();

    /* ====== Burger ====== */
    $('#burgerBtn')?.addEventListener('click', ()=>{
      const m=$('#mobileMenu'); const ex=$('#burgerBtn').getAttribute('aria-expanded')==='true';
      $('#burgerBtn').setAttribute('aria-expanded', (!ex).toString()); m.classList.toggle('hidden');
    });

    /* ====== Konfigurasi Donasi (ubah sesuai real) ====== */
    const TARGET     = 42000000;   // JPY
    const TERKUMPUL  = 5290797;    // JPY
    const WA_NUMBER  = '818013909425';
    const ADMIN_CODE = 'as-sunnah-2025';

    /* ====== Admin Gate ====== */
    const isAdmin = ()=> localStorage.getItem('is_admin')==='1' || new URLSearchParams(location.search).get('admin')==='1';
    if(isAdmin()) $$('.admin-only').forEach(el=> el.classList.remove('hidden'));
    // Shortcut: Ctrl+Alt+A untuk login admin
    document.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.altKey && e.key.toLowerCase()==='a'){
        const code = prompt('Masukkan kode admin:');
        if(code===ADMIN_CODE){ localStorage.setItem('is_admin','1'); alert('Admin mode aktif.'); $$('.admin-only').forEach(el=> el.classList.remove('hidden')); }
        else if(code) alert('Kode salah.');
      }
    });

    /* ====== Modal Admin ====== */
    function openDataModal(){ $('#csvPengumuman').value=localStorage.getItem('sheet_pengumuman')||''; $('#csvArtikel').value=localStorage.getItem('sheet_artikel')||''; $('#dataModal').classList.remove('hidden'); $('#dataModal').classList.add('flex'); }
    function closeDataModal(){ $('#dataModal').classList.add('hidden'); $('#dataModal').classList.remove('flex'); }
    $('#openData')?.addEventListener('click', e=>{e.preventDefault(); openDataModal();});
    $('#closeData')?.addEventListener('click', closeDataModal);
    $('#dataModal')?.addEventListener('click', e=>{ if(e.target.id==='dataModal') closeDataModal(); });
    $('#saveData')?.addEventListener('click', ()=>{
      const p=$('#csvPengumuman').value.trim(), a=$('#csvArtikel').value.trim();
      if(p) localStorage.setItem('sheet_pengumuman', p); else localStorage.removeItem('sheet_pengumuman');
      if(a) localStorage.setItem('sheet_artikel', a);    else localStorage.removeItem('sheet_artikel');
      alert('Sumber data disimpan (browser ini).');
      closeDataModal();
      loadInfo(); // refresh konten
    });

    /* ====== Jadwal Sholat (anti loading selamanya) ====== */
    const FALLBACK = { lat:34.884, lon:136.993, label:'Hekinan, Aichi' };
    const labelMap = {Fajr:'Subuh',Sunrise:'Syuruq',Dhuhr:'Dzuhur',Asr:'Ashar',Maghrib:'Maghrib',Isha:'Isya'};
    const iconMap  = {Fajr:'sunrise',Sunrise:'sun',Dhuhr:'clock',Asr:'cloud-sun',Maghrib:'moon',Isha:'star'};

    function card(name, time, ic){
      const el = document.createElement('div');
      el.className = "rounded-xl border border-slate-200 p-4 text-center bg-white";
      el.innerHTML = `<i data-lucide="${ic}" class="w-5 h-5 mx-auto text-sky-600 mb-2"></i>
                      <div class="text-xs text-slate-500">${name}</div>
                      <div class="mt-1 text-xl font-bold text-slate-900">${time||'—'}</div>`;
      return el;
    }
    function withTimeout(promise, ms=8000){ // 8 detik
      const t = new Promise((_,rej)=> setTimeout(()=>rej(new Error('timeout')), ms));
      return Promise.race([promise,t]);
    }
    async function getGeo(){
      return await withTimeout(new Promise(resolve=>{
        if(!navigator.geolocation) return resolve(null);
        navigator.geolocation.getCurrentPosition(p=> resolve({lat:p.coords.latitude, lon:p.coords.longitude}), ()=> resolve(null), {enableHighAccuracy:true, timeout:7000});
      }), 7500).catch(()=>null);
    }
    async function getCity(lat,lon){
      try{
        const j = await withTimeout(fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`), 7000).then(r=>r.json());
        return j.address?.city || j.address?.town || j.address?.state || 'Tidak diketahui';
      }catch{ return 'Tidak diketahui'; }
    }
    async function getTimes(lat,lon){
      const j = await withTimeout(fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`), 8000).then(r=>r.json());
      return j.data?.timings;
    }
    async function renderSholat(){
      const GRID = $('#sholatGrid'), LOC = $('#locLabel'), BTN = $('#refreshSholat');
      GRID.innerHTML = '<div class="col-span-2 md:col-span-6 text-sm text-slate-500">Memuat jadwal…</div>';
      BTN.classList.add('animate-spin');
      try{
        const geo = await getGeo();
        const pos = geo || FALLBACK;
        const city = await getCity(pos.lat, pos.lon);
        LOC.textContent = `Lokasi: ${city} • (${pos.lat.toFixed(3)}, ${pos.lon.toFixed(3)})`;
        const t = await getTimes(pos.lat, pos.lon);
        GRID.innerHTML = '';
        ['Fajr','Sunrise','Dhuhr','Asr','Maghrib','Isha'].forEach(k=> GRID.appendChild(card(labelMap[k], t?.[k]||'—', iconMap[k])));
        lucide.createIcons();
      }catch{
        GRID.innerHTML = '<div class="col-span-2 md:col-span-6 text-sm text-red-600">Gagal memuat jadwal. Silakan tekan Perbarui.</div>';
      }finally{
        BTN.classList.remove('animate-spin');
      }
    }
    $('#refreshSholat').addEventListener('click', renderSholat);
    renderSholat();

    /* ====== Slideshow Kegiatan ====== */
    (function(){
      const track = $('#kgTrack'); if(!track) return;
      const prevs=[$('#kgPrev'),$('#kgPrevMob')].filter(Boolean), nexts=[$('#kgNext'),$('#kgNextMob')].filter(Boolean);
      const page=()=>track.clientWidth; const go=d=>track.scrollBy({left:d*page(),behavior:'smooth'});
      prevs.forEach(b=>b?.addEventListener('click',()=>go(-1)));
      nexts.forEach(b=>b?.addEventListener('click',()=>go(1)));
      let timer = setInterval(()=>go(1), 6000);
      track.addEventListener('mouseenter', ()=> clearInterval(timer));
      track.addEventListener('mouseleave', ()=> timer = setInterval(()=>go(1), 6000));
    })();

    /* ====== Tabs Pengumuman/Artikel ====== */
    (function(){
      const tabs = $('#tabs'); const wPeng = $('#wrapPengumuman'); const wArt = $('#wrapArtikel');
      $('#tabPengumuman').addEventListener('click',()=>{ wPeng.classList.remove('hidden'); wArt.classList.add('hidden'); tabs.classList.add('tab-left'); tabs.classList.remove('tab-right'); });
      $('#tabArtikel').addEventListener('click',()=>{ wPeng.classList.add('hidden'); wArt.classList.remove('hidden'); tabs.classList.remove('tab-left'); tabs.classList.add('tab-right'); });
    })();

    /* ====== Data Dinamis (CSV/JSON/sample) ====== */
    function parseCSV(text){ return text.trim().split(/\r?\n/).map(r=>r.split(',').map(c=>c.trim())); }
    async function loadCsv(url){ if(!url) return null; try{ const txt=await fetch(url,{cache:'no-store'}).then(r=>r.text()); const rows=parseCSV(txt); const head=rows[0].map(h=>h.toLowerCase()); return rows.slice(1).map(cols=>{const o={}; head.forEach((h,i)=>o[h]=cols[i]||''); return o;}); }catch{return null;} }
    async function loadJson(url){ try{ return await fetch(url,{cache:'no-store'}).then(r=>r.json()); }catch{return null;} }

    async function getPengumuman(){
      const csv = await loadCsv(localStorage.getItem('sheet_pengumuman')||''); if(csv && csv.length) return csv;
      const js  = await loadJson('pengumuman.json'); if(js && js.length) return js;
      return [
        { title:'Kajian Ahad Pagi', date:'2025-11-10', desc:'Kajian rutin ba’da Subuh.', link:'#' },
        { title:'Open Donasi Perbaikan Wudhu', date:'2025-11-15', desc:'Bantu perbaikan area wudhu.', link:'#' },
      ];
    }
    async function getArtikel(){
      const csv = await loadCsv(localStorage.getItem('sheet_artikel')||''); if(csv && csv.length) return csv;
      const js  = await loadJson('artikel.json'); if(js && js.length) return js;
      return [
        { title:'Keutamaan Membangun Masjid', tag:'donasi|masjid', excerpt:'Dalil & faedah membangun masjid.', link:'#' },
        { title:'Adab ke Masjid untuk Anak', tag:'adab|anak', excerpt:'Checklist adab singkat.', link:'#' },
        { title:'Panduan Wudhu Singkat', tag:'fiqih', excerpt:'Tata cara wudhu sesuai sunnah.', link:'#' }
      ];
    }

    function cardPengumuman({title,date,desc,link}){
      const el=document.createElement('article'); el.className="rounded-2xl border border-slate-200 bg-white p-5 shadow card";
      const dt=date?new Date(date):null; const d=dt&&!isNaN(dt)?dt.toLocaleDateString('id-ID',{weekday:'short',year:'numeric',month:'short',day:'numeric'}):'';
      el.innerHTML=`<div class="text-xs text-slate-500">${d}</div>
        <h3 class="mt-1 font-bold text-slate-900">${title||''}</h3>
        <p class="mt-2 text-sm text-slate-700">${desc||''}</p>
        ${link?`<a href="${link}" class="inline-flex items-center gap-2 mt-3 text-sky-700 hover:underline text-sm"><i data-lucide="arrow-right"></i> Detail</a>`:''}`;
      return el;
    }
    function cardArtikel({title,excerpt,link,tag}){
      const el=document.createElement('article'); el.className="rounded-2xl border border-slate-200 bg-white p-5 shadow card";
      const badges=(tag||'').split('|').filter(Boolean).map(t=>`<span class="text-xs px-2 py-1 rounded-full bg-slate-100">${t}</span>`).join('');
      el.innerHTML=`<h3 class="font-bold text-slate-900">${title||''}</h3>
        <p class="mt-2 text-sm text-slate-700">${excerpt||''}</p>
        <div class="mt-3 flex flex-wrap gap-2">${badges}</div>
        ${link?`<a href="${link}" class="inline-flex items-center gap-2 mt-4 text-emerald-700 hover:underline text-sm"><i data-lucide="book-open"></i> Baca</a>`:''}`;
      return el;
    }

    async function loadInfo(){
      // Pengumuman
      const boardWrap = $('#wrapPengumuman'), empty = $('#boardEmpty');
      const P = await getPengumuman(); boardWrap.innerHTML=''; 
      if(!P.length){ empty.classList.remove('hidden'); } else { empty.classList.add('hidden'); P.forEach(x=> boardWrap.appendChild(cardPengumuman(x))); }

      // Artikel
      const A = await getArtikel(); const list = $('#artikelList'), ept = $('#artikelEmpty'); const q = ($('#searchArtikel')?.value||'').toLowerCase();
      function renderArtikel(){
        list.innerHTML='';
        const filtered = A.filter(a=>{
          const tags=(a.tag||'').toLowerCase();
          return !($('#searchArtikel')?.value) || (a.title||'').toLowerCase().includes(q) || (a.excerpt||'').toLowerCase().includes(q) || tags.includes(q);
        });
        if(!filtered.length){ ept.classList.remove('hidden'); return; }
        ept.classList.add('hidden');
        filtered.forEach(a=> list.appendChild(cardArtikel(a)));
        lucide.createIcons();
      }
      renderArtikel();
      $('#searchArtikel')?.addEventListener('input', ()=>{ loadInfo(); });
      lucide.createIcons();
    }
    loadInfo();

    /* ====== Donasi (progress + nominal + WA + copy) ====== */
    function renderProgress(){
      $('#terkumpulLabel').textContent = fmtJPY(TERKUMPUL);
      $('#targetLabel').textContent    = fmtJPY(TARGET);
      const p = Math.min(100, Math.round((TERKUMPUL/TARGET)*100));
      $('#percentLabel').textContent = p;
      const bar = $('#progressBar'); bar.style.width='0%'; requestAnimationFrame(()=> setTimeout(()=> bar.style.width = p + '%', 40));
    }
    renderProgress();

    $$('.quick-btn-jpy').forEach(b=> b.addEventListener('click', ()=> $('#inputJPY').value = b.dataset.v ));
    $$('.quick-btn-idr').forEach(b=> b.addEventListener('click', ()=> $('#inputIDR').value = b.dataset.v ));
    $('#donasiBtn').addEventListener('click', ()=>{
      const jpy = Number($('#inputJPY').value)||0, idr = Number($('#inputIDR').value)||0;
      if(jpy < 1000 && idr < 10000){ alert('Minimal 1.000 JPY atau 10.000 IDR.'); return; }
      const msg = encodeURIComponent(`Assalamu'alaikum, saya ingin donasi sebesar ${jpy>0?fmtJPY(jpy):fmtIDR(idr)} untuk pelunasan Masjid As-Sunnah Hekinan.`);
      window.open(`https://wa.me/${WA_NUMBER}?text=${msg}`,'_blank');
    });

    $$('[data-copy]').forEach(btn=> btn.addEventListener('click', ()=>{
      const sel = btn.getAttribute('data-copy'); const t = document.querySelector(sel);
      if(!t) return; navigator.clipboard.writeText(String(t.textContent).trim());
      const o=btn.textContent; btn.textContent='Disalin!'; setTimeout(()=> btn.textContent=o,1200);
    }));
  </script>
</body>
</html>
